// Generated by CoffeeScript 1.3.3

/*
// ==UserScript==  
// @name        NicoVideo Concealer
// @namespace   https://github.com/KoharaKazuya
// @description ニコニコ動画のランキングページで既に見た動画を隠します。
// @include     http://www.nicovideo.jp/ranking*
// @include     http://www.nicovideo.jp/search*
// @include     http://www.nicovideo.jp/tag*
// @require     http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js
// ==/UserScript==
*/


(function() {
  var Watch, Watch_Fav, Watch_Matrix, Watch_Search, Watch_Top, add_all_hide_button, check_all_watches, init, match, prefix_id, watches,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  prefix_id = 'visited_';

  match = function(type) {
    return location.href.indexOf(type) !== -1;
  };

  Watch = (function() {

    function Watch($link) {
      var _this = this;
      this.$link = $link;
      this.id = (function() {
        _this.$link.attr('href').match(/watch\/([a-z0-9]+)/);
        return RegExp.$1;
      })();
      this.$box = this.select_box();
      this.$thumb = this.select_thumb();
      this.$useless = this.select_useless();
      this.$button = $('<a href="javascript:;;"</a>').css({
        textDecoration: 'none',
        fontWeight: 'bold',
        fontSize: '12px',
        backgroundColor: 'white'
      }).text('[×]').bind('click', function() {
        return _this.hide();
      });
      (function() {
        var $field;
        $field = $('<div></div>').css({
          textAlign: 'right',
          position: 'absolute',
          top: '0',
          right: '0'
        });
        return _this.$box.css('position', 'relative').append($field.append(_this.$button));
      })();
    }

    Watch.prototype.show = function() {
      var _this = this;
      this.$box.css('opacity', '1');
      this.$thumb.css({
        width: '96px',
        height: '72px'
      });
      this.$button.text('[×]').bind('click', function() {
        return _this.hide();
      });
      this.$useless.show();
      return this.unvisit();
    };

    Watch.prototype.hide = function() {
      var _this = this;
      this.$box.css('opacity', '0.5');
      this.$thumb.css({
        width: '65px',
        height: '50px'
      });
      this.$button.text('[○]').bind('click', function() {
        return _this.show();
      });
      this.$useless.hide();
      return this.visit();
    };

    Watch.prototype.visit = function() {
      return GM_setValue(prefix_id + this.id, true);
    };

    Watch.prototype.unvisit = function() {
      return GM_setValue(prefix_id + this.id, false);
    };

    Watch.prototype.isVisited = function() {
      return GM_getValue(prefix_id + this.id, false);
    };

    return Watch;

  })();

  Watch_Top = (function(_super) {

    __extends(Watch_Top, _super);

    function Watch_Top() {
      return Watch_Top.__super__.constructor.apply(this, arguments);
    }

    Watch_Top.prototype.select_box = function() {
      return this.$link.parent().parent().parent();
    };

    Watch_Top.prototype.select_thumb = function() {
      return this.$link.parent().parent().prev().find('img');
    };

    Watch_Top.prototype.select_useless = function() {
      return this.$link.parent().siblings();
    };

    return Watch_Top;

  })(Watch);

  Watch_Matrix = (function(_super) {

    __extends(Watch_Matrix, _super);

    function Watch_Matrix() {
      return Watch_Matrix.__super__.constructor.apply(this, arguments);
    }

    Watch_Matrix.prototype.select_box = function() {
      return this.$link.parent().parent();
    };

    Watch_Matrix.prototype.select_thumb = function() {
      return this.$link.parent().prev().children().children().children();
    };

    Watch_Matrix.prototype.select_useless = function() {
      return this.$link.parent().prev().prev();
    };

    return Watch_Matrix;

  })(Watch);

  Watch_Fav = (function(_super) {

    __extends(Watch_Fav, _super);

    function Watch_Fav() {
      return Watch_Fav.__super__.constructor.apply(this, arguments);
    }

    Watch_Fav.prototype.select_box = function() {
      return this.$link.parent().parent().parent().parent().parent().parent().parent();
    };

    Watch_Fav.prototype.select_thumb = function() {
      return this.$link.parent().parent().parent().prev().find('img');
    };

    Watch_Fav.prototype.select_useless = function() {
      return this.$link.parent().siblings();
    };

    return Watch_Fav;

  })(Watch);

  Watch_Search = (function(_super) {

    __extends(Watch_Search, _super);

    function Watch_Search() {
      return Watch_Search.__super__.constructor.apply(this, arguments);
    }

    Watch_Search.prototype.select_box = function() {
      return this.$link.parent().parent();
    };

    Watch_Search.prototype.select_thumb = function() {
      return this.$link.parent().prev().find('img');
    };

    Watch_Search.prototype.select_useless = function() {
      return this.$link.parent().prev().find('table').next();
    };

    return Watch_Search;

  })(Watch);

  watches = (function() {
    var $links, page_type;
    if (match('matrix')) {
      $links = $('a.watch');
      page_type = Watch_Matrix;
    } else if (match('fav')) {
      $links = $('.content_672 a.watch');
      page_type = Watch_Fav;
    } else if ((match('search')) || (match('tag'))) {
      $links = $('.content_672 a.watch');
      page_type = Watch_Search;
    } else {
      $links = $('#ranking_main a.watch');
      page_type = Watch_Top;
    }
    return $links.map((function() {
      return new page_type($(this));
    }));
  })();

  console.log(watches);

  check_all_watches = function() {
    return $.each(watches, function() {
      if (this.isVisited()) {
        return this.hide();
      }
    });
  };

  add_all_hide_button = function() {
    var $all_hide_button,
      _this = this;
    $all_hide_button = $('<div />').text('全て既読にする').addClass('bg_grade_0').css({
      width: 'auto',
      cursor: 'pointer',
      textAlign: 'center'
    }).click(function() {
      return $.each(watches, function() {
        return this.hide();
      });
    });
    if (match('matrix')) {
      return $('#PAGEBODY table.top20 table tr:eq(20)').after($('<tr />').append($('<td />')).append($('<td colspan="11" />').append($all_hide_button)));
    } else if ((match('fav')) || (match('search')) || (match('tag'))) {
      return $('div.content_672').append($all_hide_button);
    } else {
      return $('#ranking_main').append($all_hide_button);
    }
  };

  init = function() {
    check_all_watches();
    return add_all_hide_button();
  };

  init();

}).call(this);
